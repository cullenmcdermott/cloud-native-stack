# GPU Operator ClusterPolicy Manifest
# Generated from Cloud Native Stack Recipe
# Timestamp: {{ .Script.Timestamp }}
# Bundler Version: {{ .Script.Version }}
# Recipe Version: {{ .Script.RecipeVersion }}

apiVersion: nvidia.com/v1
kind: ClusterPolicy
metadata:
  name: gpu-cluster-policy
  namespace: {{ .Script.Namespace }}
spec:
  operator:
    defaultRuntime: containerd

  driver:
    {{- $driver := index .Values "driver" }}
    {{- if $driver }}
    enabled: {{ index $driver "enabled" }}
    {{- if index $driver "version" }}
    version: "{{ index $driver "version" }}"
    {{- end }}
    {{- if index $driver "useOpenKernelModules" }}
    useOpenKernelModules: true
    {{- end }}
    {{- else }}
    enabled: true
    {{- end }}

  toolkit:
    enabled: true

  devicePlugin:
    enabled: true

  dcgm:
    enabled: true

  dcgmExporter:
    enabled: true

  mig:
    {{- $mig := index .Values "mig" }}
    {{- if $mig }}
    strategy: {{ index $mig "strategy" }}
    {{- else }}
    strategy: single
    {{- end }}

  gds:
    {{- $gds := index .Values "gds" }}
    {{- if $gds }}
    enabled: {{ index $gds "enabled" }}
    {{- else }}
    enabled: false
    {{- end }}

  {{- $vgpu := index .Values "vgpuManager" }}
  {{- if $vgpu }}
  {{- if index $vgpu "enabled" }}
  vgpuManager:
    enabled: true
    {{- if index $vgpu "licenseServerURL" }}
    licenseServerURL: {{ index $vgpu "licenseServerURL" }}
    {{- end }}
  {{- end }}
  {{- end }}
