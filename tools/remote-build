#!/usr/bin/env bash
set -euo pipefail

# Configuration
GO_VERSION="${GO_VERSION:-1.24.3}"
INSTALL_DIR="${INSTALL_DIR:-/usr/local}"
PROFILE_FILE="${PROFILE_FILE:-/etc/profile.d/go.sh}"
REPO_URL="${REPO_URL:-https://github.com/mchmarny/cloud-native-stack.git}"
REPO_BRANCH="${REPO_BRANCH:-main}"
EIDOS_BIN="${EIDOS_BIN:-/usr/local/bin/eidos}"

# Detect architecture
detect_go_arch() {
  local arch
  arch="$(dpkg --print-architecture)"
  case "${arch}" in
    amd64)  echo "amd64" ;;
    arm64)  echo "arm64" ;;
    i386)   echo "386" ;;
    ppc64el) echo "ppc64le" ;;
    s390x)  echo "s390x" ;;
    *) echo "Unsupported architecture: ${arch}" >&2; exit 1 ;;
  esac
}

# Prompt for yes/no
prompt_yes_no() {
  local prompt="$1"
  local default="${2:-n}"
  local response
  
  while true; do
    if [[ "${default}" == "y" ]]; then
      read -r -p "${prompt} [Y/n]: " response
      response="${response:-y}"
    else
      read -r -p "${prompt} [y/N]: " response
      response="${response:-n}"
    fi
    
    case "${response,,}" in
      y|yes) return 0 ;;
      n|no)  return 1 ;;
      *) echo "Please answer yes or no." ;;
    esac
  done
}

# Check root
if [[ $EUID -ne 0 ]]; then
  echo "Error: This script must be run as root (e.g., sudo $0)" >&2
  exit 1
fi

# Detect system
GO_OS="linux"
GO_ARCH="$(detect_go_arch)"
GO_TARBALL="go${GO_VERSION}.${GO_OS}-${GO_ARCH}.tar.gz"
BASE_URL="https://dl.google.com/go"
GO_URL="${BASE_URL}/${GO_TARBALL}"
GO_SHA256_URL="${BASE_URL}/${GO_TARBALL}.sha256"

echo "==> Installing Go ${GO_VERSION} (${GO_OS}/${GO_ARCH})..."

# Install dependencies
apt-get update -qq
apt-get install -y --no-install-recommends ca-certificates curl tar git

# Download Go
cd /tmp
rm -f "${GO_TARBALL}" "${GO_TARBALL}.sha256"

echo "Downloading Go..."
curl -fsSL -o "${GO_TARBALL}" "${GO_URL}"
curl -fsSL -o "${GO_TARBALL}.sha256" "${GO_SHA256_URL}"

# Verify checksum
EXPECTED_SHA256="$(tr -d ' \n\r\t' < "${GO_TARBALL}.sha256")"

if [[ ! "${EXPECTED_SHA256}" =~ ^[0-9a-fA-F]{64}$ ]]; then
  echo "Error: Downloaded checksum is invalid (not 64 hex chars)." >&2
  echo "Got: ${EXPECTED_SHA256:0:120}..." >&2
  exit 1
fi

ACTUAL_SHA256="$(sha256sum "${GO_TARBALL}" | awk '{print $1}')"

if [[ "${EXPECTED_SHA256}" != "${ACTUAL_SHA256}" ]]; then
  echo "Error: Checksum mismatch for ${GO_TARBALL}" >&2
  echo "Expected: ${EXPECTED_SHA256}" >&2
  echo "Actual:   ${ACTUAL_SHA256}" >&2
  exit 1
fi
echo "Checksum verified."

# Install Go
rm -rf "${INSTALL_DIR}/go"
tar -C "${INSTALL_DIR}" -xzf "${GO_TARBALL}"

# Configure environment
cat > "${PROFILE_FILE}" <<'EOF'
# Go environment
export GOROOT=/usr/local/go
export GOPATH="$HOME/go"
export PATH="$GOROOT/bin:$GOPATH/bin:$PATH"
EOF
chmod 0644 "${PROFILE_FILE}"

# Load environment for this session
export GOROOT=/usr/local/go
export GOPATH="${HOME}/go"
export PATH="${GOROOT}/bin:${GOPATH}/bin:${PATH}"

# Verify installation
git --version
go version
echo "✓ Go installed successfully. New shells will load env from ${PROFILE_FILE}"

# Optional: Clone repository and build eidos
if prompt_yes_no "Clone cloud-native-stack repository and build eidos CLI?" "y"; then
  echo ""
  echo "==> Cloning repository..."
  
  CLONE_DIR="/tmp/cloud-native-stack"
  rm -rf "${CLONE_DIR}"
  git clone "${REPO_URL}" "${CLONE_DIR}"
  cd "${CLONE_DIR}"
  git checkout "${REPO_BRANCH}"
  
  echo "==> Building eidos..."
  go build -o "${EIDOS_BIN}" ./cmd/eidos/main.go
  chmod +x "${EIDOS_BIN}"
  
  echo "✓ Eidos installed to ${EIDOS_BIN}"
  eidos version
  
  # Optional: Run snapshot
  if prompt_yes_no "Run eidos snapshot to capture system configuration?" "y"; then
    echo ""
    echo "==> Capturing system snapshot..."
    SNAPSHOT_FILE="/tmp/eidos-snapshot.yaml"
    eidos snapshot -o yaml > "${SNAPSHOT_FILE}"
    echo "✓ Snapshot saved to ${SNAPSHOT_FILE}"
  fi
fi

echo ""
echo "✓ Setup completed successfully."